<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Wallet</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html, body {width:100%;height:100%;overflow-x:hidden;}
body{font-family:'Roboto',sans-serif;background-color:#e0e0e0;display:flex;justify-content:center;align-items:center;min-height:100vh;color:#333;}
.phone-screen{width:100%;height:100vh;max-width:480px;background-color:#f4f5f9;border-radius:0;box-shadow:none;overflow:hidden;position:relative;display:flex;flex-direction:column;}
header{text-align:center;padding:15px;background-color:#fff;border-bottom:1px solid #eee;}
header h1{font-size:1.3rem;font-weight:500;}
main{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:20px;}
.balance-card{background-color:#03A9F4;color:white;padding:20px;border-radius:12px;}
.balance-card .balance-header{display:flex;align-items:center;gap:8px;font-size:0.9rem;opacity:0.9;}
.balance-card h2{font-size:2.5rem;margin:5px 0;}
.balance-card .points{font-size:1rem;opacity:0.9;}
.balance-card .conversion-rate{background-color:rgba(255,255,255,0.2);display:inline-flex;align-items:center;gap:5px;padding:5px 10px;border-radius:20px;font-size:0.75rem;margin-top:15px;}
.withdrawal-section, .history-section{background-color:#fff;padding:15px;border-radius:12px;}
.upi-input{position:relative;margin-bottom:20px;}
.upi-input i{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#03A9F4;}
.upi-input input{width:100%;padding:12px 12px 12px 40px;border:1px solid #e0e0e0;border-radius:8px;font-size:0.9rem;background-color:#f9f9f9;}
.upi-input input::placeholder{color:#999;}
.amount-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.amount-btn{background-color:#f4f5f9;border:1px solid #e0e0e0;border-radius:8px;padding:10px;cursor:pointer;text-align:center;transition:all 0.2s ease;}
.amount-btn.selected{background-color:#e3f2fd;border-color:#03A9F4;}
.withdraw-now-btn{width:100%;padding:15px;background-color:#03A9F4;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:500;cursor:pointer;margin-top:10px;display:flex;justify-content:center;align-items:center;gap:8px;}
/* New download row */
.download-row{display:flex;justify-content:center;margin-top:10px;}
.download-btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:1px solid #e0e0e0;background:#fff;cursor:pointer;font-weight:600;color:#333;box-shadow:0 2px 6px rgba(0,0,0,0.04);}
.download-btn i{font-size:1.1rem;color:#03A9F4;}
.download-btn:active{transform:translateY(1px);}

/* History */
.history-section .history-item{display:flex;align-items:center;gap:15px;padding:10px 0;border-bottom:1px solid #eee;}
.history-section .icon-col .icon-bg{width:40px;height:40px;border-radius:50%;display:flex;justify-content:center;align-items:center;}
.history-section .details-col{flex-grow:1;}
.status{font-size:0.75rem;padding:3px 8px;border-radius:10px;font-weight:500;text-transform:capitalize;}
.status.pending{background-color:#fff8e1;color:#fbc02d;}
.status.completed{background-color:#e8f5e9;color:#2e7d32;}
.status.failed{background-color:#ffebee;color:#c62828;}
footer{position:fixed;bottom:0;left:0;right:0;background-color:#ffffff;border-top:1px solid #e0e0e0;}
footer nav{display:flex;justify-content:space-around;padding:10px 0;}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;text-decoration:none;color:#999;}
.nav-item i{font-size:1.2rem;}
.nav-item.active{color:#03A9F4;}

/* Responsive */
@media (max-width: 768px) {
  .amount-grid {grid-template-columns: repeat(2, 1fr);}
  header h1 {font-size:1.1rem;}
  .balance-card h2 {font-size:2rem;}
  .withdraw-now-btn {font-size:0.9rem;padding:12px;}
  .nav-item i {font-size:1rem;}
  .nav-item span {font-size:0.8rem;}
}
</style>
</head>
<body>
<div class="phone-screen">
  <header><h1>Wallet</h1></header>

  <main>
    <section class="balance-card">
      <div class="balance-header">
        <i class="fa-solid fa-wallet"></i><span>Current Balance</span>
      </div>
      <h2 id="walletAmount">₹0.00</h2>
      <p class="points" id="walletPoints">0 points</p>
      <div class="conversion-rate"><i class="fa-solid fa-circle-info"></i><span>1000 points = ₹1</span></div>
    </section>

    <section class="withdrawal-section">
      <div class="upi-input">
        <i class="fa-solid fa-credit-card"></i>
        <input type="text" id="upiId" placeholder="Enter UPI ID">
      </div>

      <div class="amount-grid">
        <button class="amount-btn" data-points="20000" data-rupees="20">₹20</button>
        <button class="amount-btn" data-points="50000" data-rupees="50">₹50</button>
        <button class="amount-btn" data-points="100000" data-rupees="100">₹100</button>
      </div>

      <button class="withdraw-now-btn"><i class="fa-solid fa-arrow-up-from-bracket"></i> Withdraw Now</button>

      <!-- Download transactions button with file logo -->
      <div class="download-row">
        <button id="downloadTxBtn" class="download-btn" title="Download transactions as CSV">
          <i class="fa-solid fa-file-arrow-down"></i><span>Download Transactions</span>
        </button>
      </div>
    </section>

    <section class="history-section">
      <h2><i class="fa-solid fa-clock-rotate-left"></i> Withdrawal History</h2>
      <div id="historyList"></div>
    </section>
  </main>

  <footer>
    <nav>
      <a href="spin.html" class="nav-item"><i class="fa-solid fa-sync"></i><span>Spin</span></a>
      <a href="wallet.html" class="nav-item active"><i class="fa-solid fa-wallet"></i><span>Wallet</span></a>
      <a href="prbe.html" class="nav-item"><i class="fa-solid fa-user"></i><span>Profile</span></a>
    </nav>
  </footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDllI-7XaSEX9Akcjz3hzH3eWtC_xOo0vE",
  authDomain: "spin-to-earn-ba587.firebaseapp.com",
  projectId: "spin-to-earn-ba587",
  storageBucket: "spin-to-earn-ba587.firebasestorage.app",
  messagingSenderId: "508392305853",
  appId: "1:508392305853:web:404509d298fc8ee25e73d4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let userId = null;
let userData = {points:0};

async function loginGoogle(){
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
}

onAuthStateChanged(auth, async (user)=>{
  if(user){
    userId = user.uid;
    const ref = doc(db, "users", userId);
    const snap = await getDoc(ref);
    if(snap.exists()) userData = snap.data();
    else await setDoc(ref, userData);
    updateUI();
    listenWithdrawals();
  } else loginGoogle();
});

function updateUI(){
  document.getElementById("walletPoints").innerText = userData.points + " points";
  document.getElementById("walletAmount").innerText = "₹" + (userData.points/1000).toFixed(2);
}

/* Amount selection */
const amountButtons=document.querySelectorAll('.amount-btn');
let selectedPoints=0;
amountButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    amountButtons.forEach(b=>b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedPoints=parseInt(btn.dataset.points);
  });
});

/* Withdraw action */
document.querySelector('.withdraw-now-btn').addEventListener('click',async()=>{
  const upi=document.getElementById("upiId").value;
  if(!upi) return alert("Enter UPI ID");
  if(selectedPoints===0) return alert("Select Amount");
  if(userData.points<selectedPoints) return alert("Insufficient points");

  userData.points-=selectedPoints;
  await updateDoc(doc(db,"users",userId),{points:userData.points});
  await addDoc(collection(db,"users",userId,"withdrawals"),{
    points:selectedPoints,
    amount:(selectedPoints/1000),
    upi:upi,
    status:"PENDING",
    date:new Date()
  });
  alert("Withdrawal Requested!");
});

/* Listen and render withdrawals */
function listenWithdrawals(){
  const q=query(collection(db,"users",userId,"withdrawals"),orderBy("date","desc"));
  onSnapshot(q,(snapshot)=>{
    const list=document.getElementById("historyList");
    list.innerHTML="";
    snapshot.forEach(docSnap=>{
      const d=docSnap.data();
      let icon='',statusText='';
      if(d.status==="COMPLETED"){
        icon='<i class="fa-solid fa-wallet" style="color:#2e7d32;"></i>';
        statusText='Payment Completed';
      } else if(d.status==="PENDING"){
        icon='<i class="fa-solid fa-clock" style="color:#fbc02d;"></i>';
        statusText='Pending...';
      } else {
        icon='<i class="fa-solid fa-triangle-exclamation" style="color:#c62828;"></i>';
        statusText='Failed';
      }
      const dateText = d.date && d.date.toDate ? d.date.toDate().toLocaleString() : (d.date ? new Date(d.date).toLocaleString() : '');
      list.innerHTML+=`
      <div class="history-item">
        <div class="icon-col"><div class="icon-bg">${icon}</div></div>
        <div class="details-col">
          <div class="amount-status">
            <h4>₹${d.amount}</h4>
            <span class="status ${d.status.toLowerCase()}">${statusText}</span>
          </div>
          <p class="to-address">To: ${d.upi}</p>
          <p class="date">${dateText}</p>
        </div>
      </div>`;
    });
  });
}

/* Download transactions as CSV */
document.getElementById('downloadTxBtn').addEventListener('click', async ()=>{
  if(!userId) return alert("Please sign in first.");
  try{
    const q = query(collection(db, "users", userId, "withdrawals"), orderBy("date","desc"));
    const snapshot = await getDocs(q);
    if(snapshot.empty) return alert("No transactions to download.");

    // Build CSV
    const rows = [];
    rows.push(["date","amount","points","upi","status"]); // header
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const dateVal = d.date && d.date.toDate ? d.date.toDate().toLocaleString() : (d.date ? new Date(d.date).toLocaleString() : '');
      rows.push([dateVal, d.amount, d.points, d.upi, d.status]);
    });
    const csvContent = rows.map(r => r.map(cell => {
      // escape double quotes
      if(cell === null || cell === undefined) return '';
      const s = String(cell).replace(/"/g,'""');
      return `"${s}"`;
    }).join(",")).join("\n");

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const filename = `transactions_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }catch(err){
    console.error(err);
    alert("Failed to download transactions.");
  }
});
</script>
</body>
</html>
